<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCRè¯†åˆ« - WXOCR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 50%, #17a2b8 100%);
            color: white;
            text-align: center;
            padding: 2rem 1rem;
            margin-bottom: 2rem;
            border-radius: 10px;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .upload-area {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .upload-area.uploaded {
            justify-content: center;
            margin-bottom: 0.5rem;
        }
        .upload-box {
            background: white;
            border: 3px dashed #28a745;
            border-radius: 15px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-box:hover {
            border-color: #20c997;
            background: #f8fff9;
            transform: translateY(-2px);
        }
        .upload-box input[type="file"] {
            display: none;
        }
        .upload-icon {
            font-size: 3rem;
            color: #28a745;
            margin-bottom: 1rem;
        }
        .upload-text {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .upload-hint {
            font-size: 0.9rem;
            color: #666;
        }
        .result-area {
            display: none;
            flex: 1;
            gap: 2rem;
            animation: fadeIn 0.5s ease;
            min-height: 0; /* ç¡®ä¿flexå­é¡¹èƒ½æ­£ç¡®æ”¶ç¼© */
        }
        .result-area.show {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-width: 0; /* é˜²æ­¢gridé¡¹ç›®æº¢å‡º */
        }
        .image-panel, .ocr-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 0; /* å…è®¸é¢æ¿æ”¶ç¼© */
            min-width: 0; /* é˜²æ­¢gridé¡¹ç›®æº¢å‡º */
        }
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        .panel-title {
            font-size: 1.3rem;
            color: #28a745;
            margin-left: 0.5rem;
        }
        .panel-icon {
            font-size: 1.5rem;
            color: #28a745;
        }
        .image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            overflow: auto;
        }
        .image-container img {
            max-width: 100%;
            width: auto;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 1rem;
        }
        .ocr-content {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            overflow: auto;
            color: #333;
            word-break: break-word;
            min-width: 0; /* é˜²æ­¢flexé¡¹ç›®æº¢å‡º */
            position: relative;
        }
        .ocr-content.text-view {
            position: relative;
            white-space: nowrap;
        }
        .ocr-content.json-view {
            white-space: pre;
        }
        .ocr-canvas {
            position: relative;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            overflow: auto;
            min-height: 200px;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            max-width: 100%;
            max-height: 100%;
        }
        .ocr-text-block {
            position: absolute;
            font-size: 14px;
            line-height: 1.2;
            color: #333;
            cursor: default;
            white-space: nowrap;
            user-select: text;
            max-width: 100vw; /* é˜²æ­¢æ–‡æœ¬å—è¿‡å®½ */
        }
        .view-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        .toggle-btn {
            background: transparent;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.2s;
            border-radius: 0;
        }
        .toggle-btn:hover {
            background: rgba(40, 167, 69, 0.1);
        }
        .toggle-btn.active {
            background: #28a745;
            color: white;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #28a745;
        }
        .loading.show {
            display: block;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .nav-link {
            color: #ffc107;
            text-decoration: none;
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            transition: all 0.2s;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            color: #fff;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 968px) {
            .result-area.show {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 10px;
            }
            .header h1 {
                font-size: 2rem;
            }
        }
        @media (max-width: 480px) {
            .upload-box {
                padding: 2rem 1rem;
                min-width: 250px;
            }
            .upload-text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center;">
                <h1 style="margin: 0;">OCRå›¾ç‰‡è¯†åˆ«</h1>
                <a href="/" class="nav-link">è¿”å›é¦–é¡µ</a>
            </div>
            <p>ä¸Šä¼ å›¾ç‰‡è¿›è¡Œæ–‡å­—è¯†åˆ«ï¼Œæ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-box" id="uploadBox">
                <input type="file" id="fileInput" accept="image/*">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF ç­‰å¸¸è§å›¾ç‰‡æ ¼å¼</div>
            </div>
        </div>

        <div class="upload-notice">
            <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1rem;">
                âš ï¸ è¯¥åŠŸèƒ½ä»…ç”¨äºæ¼”ç¤ºï¼Œè¦æ±‚å›¾ç‰‡å¤§å°åœ¨15KBä»¥ä¸‹
            </p>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            æ­£åœ¨è¿›è¡ŒOCRè¯†åˆ«ï¼Œè¯·ç¨å€™...
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="result-area" id="resultArea">
            <div class="image-panel">
                <div class="panel-header">
                    <span class="panel-icon">ğŸ–¼ï¸</span>
                    <h2 class="panel-title">åŸå§‹å›¾ç‰‡</h2>
                </div>
                <div class="image-container">
                    <img id="originalImage" src="" alt="ä¸Šä¼ çš„å›¾ç‰‡">
                </div>
            </div>

            <div class="ocr-panel">
                <div class="panel-header">
                    <div style="display: flex; align-items: center;">
                        <span class="panel-icon">ğŸ“</span>
                        <h2 class="panel-title">è¯†åˆ«ç»“æœ</h2>
                    </div>
                    <div class="view-toggle" id="viewToggle">
                        <button class="toggle-btn active" data-view="text">æ–‡æœ¬</button>
                        <button class="toggle-btn" data-view="json">åŸå§‹</button>
                    </div>
                </div>
                <div class="ocr-content text-view" id="ocrContent">
                    è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBox = document.getElementById('uploadBox');
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const resultArea = document.getElementById('resultArea');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            const originalImage = document.getElementById('originalImage');
            const ocrContent = document.getElementById('ocrContent');
            const viewToggle = document.getElementById('viewToggle');
            const toggleBtns = viewToggle.querySelectorAll('.toggle-btn');

            let currentView = 'text';
            let currentResult = null; // å­˜å‚¨æœ€æ–°çš„OCRç»“æœ

            // è§†å›¾åˆ‡æ¢åŠŸèƒ½
            toggleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.dataset.view;
                    if (view !== currentView) {
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        toggleBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');

                        // æ›´æ–°è§†å›¾
                        currentView = view;
                        ocrContent.classList.remove('text-view', 'json-view');
                        ocrContent.classList.add(view + '-view');

                        // å¦‚æœæœ‰ç»“æœæ•°æ®ï¼Œé‡æ–°æ˜¾ç¤º
                        if (currentResult) {
                            displayOCRResult(currentResult);
                        }
                    }
                });
            });

            // ç‚¹å‡»ä¸Šä¼ æ¡†è§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadBox.addEventListener('click', function() {
                fileInput.click();
            });

            // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
            uploadBox.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#20c997';
                this.style.background = '#f8fff9';
            });

            uploadBox.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#28a745';
                this.style.background = 'white';
            });

            uploadBox.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#28a745';
                this.style.background = 'white';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
            function handleFile(file) {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º15KB)
                if (file.size > 15 * 1024) {
                    showError('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡15KB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageSrc = e.target.result;
                    displayImage(imageSrc);
                    performOCR(imageSrc);
                };
                reader.readAsDataURL(file);
            }

            // æ˜¾ç¤ºä¸Šä¼ çš„å›¾ç‰‡
            function displayImage(imageSrc) {
                originalImage.src = imageSrc;

                // åŠ¨ç”»æ•ˆæœï¼šä¸Šä¼ æŒ‰é’®ç§»åŠ¨åˆ°ä¸‹æ–¹
                uploadArea.classList.add('uploaded');

                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                setTimeout(() => {
                    resultArea.classList.add('show');
                }, 300);
            }

            // æ‰§è¡ŒOCRè¯†åˆ«
            async function performOCR(imageSrc) {
                loading.classList.add('show');
                errorMessage.classList.remove('show');
                ocrContent.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­...';

                try {
                    // æå–base64æ•°æ®ï¼ˆå»é™¤data:imageå‰ç¼€ï¼‰
                    const base64Data = imageSrc.split(',')[1];

                    const response = await fetch('/ocr/demo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: base64Data
                        })
                    });

                    const result = await response.json();
                    loading.classList.remove('show');

                    if (response.ok && result.errcode === 0) {
                        displayOCRResult(result);
                    } else {
                        showError(result.msg || 'OCRè¯†åˆ«å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    loading.classList.remove('show');
                    showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
                }
            }

            // æ˜¾ç¤ºOCRè¯†åˆ«ç»“æœ
            function displayOCRResult(result) {
                // å­˜å‚¨ç»“æœæ•°æ®
                currentResult = result;

                if (currentView === 'text') {
                    // æ–‡æœ¬è§†å›¾ï¼šæ ¹æ®ä½ç½®ä¿¡æ¯è¿˜åŸæ˜¾ç¤º
                    displayTextWithPosition(result);
                } else {
                    // åŸå§‹è§†å›¾ï¼šæ˜¾ç¤ºæ ¼å¼åŒ–çš„JSONç»“æœ
                    ocrContent.textContent = JSON.stringify(result, null, 2);
                }
            }

            // æ ¹æ®ä½ç½®ä¿¡æ¯æ˜¾ç¤ºæ–‡æœ¬
            function displayTextWithPosition(result) {
                ocrContent.innerHTML = '';

                if (!result.ocr_response || result.ocr_response.length === 0) {
                    ocrContent.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">æœªè¯†åˆ«åˆ°æ–‡å­—å†…å®¹</div>';
                    return;
                }

                // åˆ›å»ºç”»å¸ƒå®¹å™¨
                const canvas = document.createElement('div');
                canvas.className = 'ocr-canvas';

                // è®¡ç®—æ‰€æœ‰æ–‡æœ¬å—çš„ä½ç½®èŒƒå›´
                let minLeft = Infinity;
                let minTop = Infinity;
                let maxRight = 0;
                let maxBottom = 0;

                result.ocr_response.forEach(item => {
                    const left = item.left || 0;
                    const top = item.top || 0;
                    const right = item.right || 0;
                    const bottom = item.bottom || 0;

                    minLeft = Math.min(minLeft, left);
                    minTop = Math.min(minTop, top);
                    maxRight = Math.max(maxRight, right);
                    maxBottom = Math.max(maxBottom, bottom);
                });

                const containerWidth = ocrContent.clientWidth || 500;
                const containerHeight = ocrContent.clientHeight || 400;

                // æ ¹æ®OCRåæ ‡èŒƒå›´è®¾ç½®ç”»å¸ƒå°ºå¯¸
                const padding = 40;
                const contentWidth = maxRight - minLeft;
                const contentHeight = maxBottom - minTop;

                // è®¾ç½®ç”»å¸ƒå°ºå¯¸ï¼Œç¡®ä¿å†…å®¹å®Œæ•´æ˜¾ç¤º
                const canvasWidth = contentWidth + padding * 2;
                const canvasHeight = contentHeight + padding * 2;

                canvas.style.width = canvasWidth + 'px';
                canvas.style.height = canvasHeight + 'px';

                // ä¸ä½¿ç”¨ç¼©æ”¾ï¼Œè®©ç”»å¸ƒä¿æŒåŸå§‹å°ºå¯¸ï¼Œé€šè¿‡æ»šåŠ¨æ¡æŸ¥çœ‹è¶…å‡ºéƒ¨åˆ†
                const scale = 1;

                        // æ·»åŠ æ–‡æœ¬å—åˆ°ç”»å¸ƒ
                result.ocr_response.forEach((item, index) => {
                    const textBlock = document.createElement('div');
                    textBlock.className = 'ocr-text-block';
                    textBlock.textContent = item.text;

                    // è°ƒæ•´ä½ç½®ï¼Œè€ƒè™‘åç§»é‡å’Œæœ€ç»ˆçš„ç¼©æ”¾
                    const adjustedLeft = ((item.left || 0) - minLeft + padding) * scale;
                    const adjustedTop = ((item.top || 0) - minTop + padding) * scale;

                    textBlock.style.left = adjustedLeft + 'px';
                    textBlock.style.top = adjustedTop + 'px';

                    // æ ¹æ®è¯†åˆ«ç½®ä¿¡åº¦è°ƒæ•´é€æ˜åº¦
                    const confidence = item.rate || 1;
                    textBlock.style.opacity = 0.7 + (confidence * 0.3);

                    canvas.appendChild(textBlock);
                });

                ocrContent.appendChild(canvas);
            }

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            function showError(message) {
                loading.classList.remove('show');
                errorMessage.textContent = message;
                errorMessage.classList.add('show');
                ocrContent.textContent = 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
            }
        });
    </script>
</body>
</html>